[Clashä½¿ç”¨è¯´æ˜ Â· Issue #8 Â· zhongfly/blog Â· GitHub](https://github.com/zhongfly/blog/issues/8)

ä»£ç†æ¨¡å¼

- Globalï¼Œå…¨å±€æ¨¡å¼ã€‚æ‰€æœ‰æµé‡å…¨éƒ¨é€šè¿‡æ‰€é€‰æ‹©çš„æœåŠ¡å™¨è¿›è¡Œä»£ç†

- Ruleï¼Œè§„åˆ™æ¨¡å¼ã€‚æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„è§„åˆ™è¿›è¡Œä»£ç†ã€‚

- Directã€‚æ‰€æœ‰è¿›å…¥Clashçš„æµé‡éƒ½èµ°ç›´è¿ï¼Œä¸ä½¿ç”¨ä»£ç†ã€‚

- Scriptã€‚æ ¹æ®é«˜çº§è„šæœ¬è¿›è¡Œåˆ†æµ





# é›¶ã€é—®é¢˜ & æ¦‚å¿µ

## æ¦‚å¿µ

##### 1. TUN Mode

éš§é“æ¨¡å¼ã€‚ç”¨äºå®ç°**æ•´æœºä»£ç†**ï¼Œè®©æ‰€æœ‰ç½‘ç»œæµé‡éƒ½ç»è¿‡ä»£ç†ã€‚

## é—®é¢˜

##### 1. TUN Mode å’Œ Global çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ

- **TUN æ¨¡å¼**èƒ½å¤Ÿå¤„ç†æ›´å¤šçš„åº•å±‚æµé‡å’Œåè®®ï¼Œå°¤å…¶æ˜¯ UDP æµé‡ï¼Œé€‚ç”¨äºé‚£äº›ä¸å®¹æ˜“é€šè¿‡ä¼ ç»Ÿä»£ç†åè®®ï¼ˆå¦‚ HTTP/HTTPSï¼‰å¤„ç†çš„æµé‡ï¼Œæ¯”å¦‚æ¸¸æˆæµé‡ã€å®æ—¶è¯­éŸ³å’Œè§†é¢‘æµç­‰ã€‚

  **Global æ¨¡å¼**æ›´å¸¸è§äºåŸºäº **HTTP/HTTPS** æˆ– **SOCKS** çš„ä»£ç†ç³»ç»Ÿä¸­ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿçš„ç½‘ç»œå±‚ä»£ç†é…ç½®ã€‚å®ƒä¸éœ€è¦ä¿®æ”¹æ“ä½œç³»ç»Ÿçš„åº•å±‚ç½‘ç»œå±‚ï¼Œåªè¦é…ç½®ä»£ç†å·¥å…·å³å¯ã€‚

##### 2. ä¸¤ç§ä»£ç†æ¨¡å¼ HTTP(s) å’Œ SOCKS5 çš„åŒºåˆ«ï¼Ÿ






# ä¸€ã€Windows å¹³å°ä¸‹è®© PowerShell ä½¿ç”¨ Clash ä»£ç†ã€‚



## æ–¹æ³•ä¸€ï¼š è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡

1. æ‰¾åˆ°ç¯å¢ƒå˜é‡

2. åœ¨ç”¨æˆ·å˜é‡æˆ–ç³»ç»Ÿå˜é‡ä¸­ï¼Œç‚¹å‡»æ–°å»º

   - æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š

   - ```
     HTTP_PROXYï¼šhttp://127.0.0.1:ç«¯å£å·
     HTTPS_PROXYï¼šhttp://127.0.0.1:ç«¯å£å·
     ALL_PROXYï¼šhttp://127.0.0.1:ç«¯å£å·
     ```

     - `127.0.0.1` æ˜¯æœ¬åœ°åœ°å€ï¼Œ ç«¯å£å·ä¸ Clash ä¸­çš„ç›¸åŒï¼Œé»˜è®¤ä¸º 7890

3. ä¿å­˜ï¼Œé‡å¯ PowerShell æˆ–é‡å¯ç”µè„‘ï¼Œç¡®ä¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ

## æ–¹æ³•äºŒï¼šPowerShell ä¸­ä¸´æ—¶è®¾ç½®ä»£ç†

```
$proxy = "http://127.0.0.1:ç«¯å£å·"

# è®¾ç½® HTTP å’Œ HTTPS ä»£ç†
[System.Net.WebRequest]::DefaultWebProxy = New-Object System.Net.WebProxy($proxy)
[System.Net.WebRequest]::DefaultWebProxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials

# è®¾ç½®ç¯å¢ƒå˜é‡
$env:HTTP_PROXY = $proxy
$env:HTTPS_PROXY = $proxy
$env:ALL_PROXY = $proxy
```

# äºŒã€ä»£ç†çš„è´¦å·å’Œå¯†ç 

## é—®é¢˜æè¿°ï¼š

åœ¨Windowsä¸Šæ‰“å¼€äº†Clashçš„ä»£ç†åï¼ŒAndroid Studio ä¸­çš„ Gemini è¦æ±‚è¾“å…¥ä»£ç†è´¦å·å’Œå¯†ç /

### å¯èƒ½åŸå› 1: åœ¨Clashé…ç½®äº† authentication | ç»æ’æŸ¥ï¼Œæ’é™¤è¯¥åŸå› 

æ‰“å¼€ Clash çš„é…ç½®æ–‡ä»¶ï¼ˆ`.yaml`ï¼‰ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰

```yaml
authentication:
  - user:pass
```



##### è§£å†³æ–¹æ¡ˆï¼š

- å¡«å†™åœ¨é…ç½®ä¸­çš„è®¾ç½®çš„ user å’Œ pass
- æˆ–è€…å»æ‰ authentication é…ç½®ï¼Œä¿å­˜å¹¶é‡å¯ Clash



### å¯èƒ½åŸå› 2ï¼šä½¿ç”¨äº† Clash çš„ Http(s) ä»£ç†ï¼Œä½† Gemini é»˜è®¤åªæ”¯æŒ SOCKS5

##### è§£å†³æ–¹æ¡ˆï¼šåœ¨ Android Studio ä¸­è®¾ç½®

```rust
File -> Settings -> Appearance & Behavior -> System Settings -> HTTP Proxy
```

è®¾ç½®ä»£ç†æ–¹å¼å¦‚ä¸‹ï¼š

- **Manual proxy configuration**
  - Host name: `127.0.0.1`
  - Port: Clash çš„ HTTP ä»£ç†ç«¯å£ï¼ˆé»˜è®¤æ˜¯ `7890`ï¼‰
  - å‹¾é€‰ `No Proxy for: localhost, 127.0.0.1`
  - å¦‚æœ Clash æ²¡æœ‰è®¾ç½®è®¤è¯ï¼Œå°±ä¸è¦å¡«å†™è´¦å·å¯†ç ã€‚

### å¯é€‰ï¼šä½¿ç”¨ TUN æ¨¡å¼é¿å…ä»£ç†è®¾ç½®

- å…·ä½“è§â€œå››ã€TUN æ¨¡å¼â€

# ä¸‰ã€ä»£ç†åè®®

## 1. ä¸¤ç§ä»£ç†åè®®

| åè®®ç±»å‹            | ç®€ä»‹                                                         |
| ------------------- | ------------------------------------------------------------ |
| **HTTP/HTTPS ä»£ç†** | ä¸“ä¸ºè½¬å‘ HTTP æˆ– HTTPS è¯·æ±‚è€Œè®¾è®¡çš„ä»£ç†ï¼Œå·¥ä½œåœ¨**åº”ç”¨å±‚**ã€‚  |
| **SOCKS5 ä»£ç†**     | é€šç”¨å‹çš„ç½‘ç»œä»£ç†åè®®ï¼Œå·¥ä½œåœ¨**ä¼šè¯å±‚**ï¼ˆç¬¬äº”å±‚ï¼‰ï¼Œæ”¯æŒå‡ ä¹æ‰€æœ‰ç±»å‹çš„æµé‡ï¼ŒåŒ…æ‹¬ TCP å’Œ UDPã€‚ |



##### è¯¦ç»†å¯¹æ¯”

| ç‰¹æ€§             | HTTP/HTTPS ä»£ç†                | SOCKS5 ä»£ç†                      |
| ---------------- | ------------------------------ | -------------------------------- |
| å·¥ä½œå±‚çº§         | åº”ç”¨å±‚ï¼ˆHTTP åè®®ï¼‰            | ä¼šè¯å±‚ï¼ˆTCP/UDP åè®®ï¼‰           |
| æ”¯æŒåè®®         | ä»…æ”¯æŒ HTTP/HTTPS              | æ”¯æŒ **å‡ ä¹æ‰€æœ‰åè®®**ï¼ˆTCP/UDPï¼‰ |
| æ˜¯å¦è§£æè¯·æ±‚å†…å®¹ | è§£æè¯·æ±‚å†…å®¹ï¼ˆå¯ç¼“å­˜ã€å®¡æŸ¥ç­‰ï¼‰ | ä¸è§£æï¼Œä»…è½¬å‘äºŒè¿›åˆ¶æ•°æ®         |
| æ”¯æŒ UDP         | âŒ ä¸æ”¯æŒ                       | âœ… æ”¯æŒ UDP                       |
| æ”¯æŒèº«ä»½éªŒè¯     | æ”¯æŒï¼ˆä½†ä¸å¸¸ç”¨ï¼‰               | æ”¯æŒç”¨æˆ·å+å¯†ç éªŒè¯              |
| é€‚ç”¨åœºæ™¯         | æµè§ˆå™¨ä»£ç†ã€çˆ¬è™«ã€Web æµé‡     | å…¨å±€ä»£ç†ã€æ¸¸æˆã€P2Pã€éšç§é€šä¿¡    |
| å®ç°å¤æ‚åº¦       | ç®€å•ï¼Œå¸¸ç”¨äºç½‘é¡µä»£ç†           | ç¨å¤æ‚ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§               |



## 2. å·¥ä½œåŸç†

HTTP(S) ä»£ç†

- å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ç­‰ï¼‰å°†è¯·æ±‚è½¬å‘ç»™ **HTTP ä»£ç†æœåŠ¡å™¨**ï¼Œä»£ç†æœåŠ¡å™¨å†å°†è¯·æ±‚è½¬å‘ç»™ç›®æ ‡æœåŠ¡å™¨
- ==æ”¯æŒ**æ˜æ–‡ HTTP**,ä¹Ÿæ”¯æŒ CONNECT æ–¹æ³•å®ç° HTTP ä»£ç†ï¼ˆå³â€œéš§é“â€ä»£ç†ï¼‰== 
- ä»£ç†æœåŠ¡å™¨èƒ½â€œçœ‹è§â€å†…å®¹ï¼Œå› æ­¤å¯ç”¨äºå®¡æŸ¥ã€ç¼“å­˜ç­‰



SOCKS5 ä»£ç†

- é€šç”¨å‹çš„ä»£ç†åè®®ï¼Œèƒ½ä»£ç†ä»»æ„ TCP/UDP æµé‡
- æ›´åº•å±‚ï¼Œåªè´Ÿè´£è½¬å‘æ•°æ®ï¼Œä¸è´Ÿè´£è§£æå†…å®¹
- æ”¯æŒèº«ä»½è®¤è¯ï¼ˆç”¨æˆ·åå¯†ç ï¼‰
- åº”ç”¨ï¼šæ¸¸æˆã€P2Pã€VoIPã€FTP



## 3. æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„åè®®

æ‰“å¼€ Clash é…ç½®æ–‡ä»¶æŸ¥çœ‹ï¼ˆ`config.yaml`ï¼‰

æ ¹æ®ç«¯å£ç±»å‹

```yaml
mixed-port: 7890      # å¼€å¯ HTTP + SOCKS é€šç”¨ç«¯å£
socks-port: 7891      # å•ç‹¬çš„ SOCKS5 ä»£ç†ç«¯å£
port: 7890            # ï¼ˆè€ç‰ˆæœ¬ï¼‰HTTP ä»£ç†ç«¯å£
allow-lan: true
tun:
  enable: true
```

å¦‚æœæ˜¯ `mixed-port` ï¼Œä¸æ˜¯ Clash å†³å®šç”¨å“ªç§åè®®ï¼Œç”±å‘èµ·è¿æ¥çš„å®¢æˆ·ç«¯ç¨‹åºè‡ªå·±å†³å®šåè®®ç±»å‹ã€‚

# å››ã€TUN æ¨¡å¼

##### åŠ¨æœº

ä¸€äº›è½¯ä»¶ä¸æ”¯æŒä»£ç†ç«¯å£è®¾ç½®ï¼Œä½¿ç”¨ TUN æ¨¡å¼å¯ä»¥å°†æ‰€æœ‰ç³»ç»Ÿçš„æ‰€æœ‰æµé‡å¼ºåˆ¶è½¬å‘



##### æ­¥éª¤

1. å·²ç®¡ç†å‘˜æ¨¡å¼å¯åŠ¨ Clash
2. å¯ç”¨ Service Mode
3. æ‰“å¼€ TUN å¼€å…³



## é—®é¢˜1ï¼šå¯åŠ¨TUNæ¨¡å¼åç”µè„‘æ–­ç½‘

 âœ… å·²ä»¥ç®¡ç†å‘˜æƒé™å¯åŠ¨ Clash
 âœ… å·²å¯ç”¨ Service Mode
 âœ… æˆåŠŸæ‰“å¼€ TUN æ¨¡å¼å¼€å…³
 âŒ å¯ç”¨ TUN åç”µè„‘æ–­ç½‘
 âŒ `config.yaml` ä¸­ **æœªè‡ªåŠ¨æ·»åŠ  `tun:` å­—æ®µ**

## ğŸ¯ é—®é¢˜å¯èƒ½åŸå› ä¸è§£å†³æ–¹æ³•

------

### ğŸš© åŸå›  1ï¼šè™šæ‹Ÿç½‘å¡é©±åŠ¨æœªæ­£ç¡®å®‰è£…

Clash çš„ TUN æ¨¡å¼ä¾èµ–ä¸€ä¸ª **è™šæ‹Ÿç½‘å¡ï¼ˆclash-tunï¼‰**ï¼Œå¦‚æœé©±åŠ¨æ²¡æœ‰æ­£ç¡®åŠ è½½ï¼Œå°±ä¼šå¯¼è‡´ç½‘ç»œå¼‚å¸¸æˆ–æ–­ç½‘ã€‚

#### âœ… æ£€æŸ¥æ–¹æ³•ï¼š

1. æ‰“å¼€ Windows è®¾å¤‡ç®¡ç†å™¨ï¼ˆå¿«æ·é”®ï¼šWin + X â†’ è®¾å¤‡ç®¡ç†å™¨ï¼‰
2. å±•å¼€ â€œç½‘ç»œé€‚é…å™¨â€
3. æŸ¥æ‰¾ç±»ä¼¼åç§°çš„ç½‘å¡ï¼š

```
Clash for Windows TUN
æˆ–è€…
clash-tun
æˆ–è€…
utun / wintun
```

#### âŒ å¦‚æœæ²¡æœ‰çœ‹åˆ°ï¼š

è¯´æ˜ TUN é©±åŠ¨å®‰è£…å¤±è´¥æˆ–æœªè¢«åŠ è½½ã€‚

#### âœ… è§£å†³æ–¹æ³•ï¼š

1. åœ¨ Clash å®‰è£…ç›®å½•ä¸­æŸ¥æ‰¾ `resources/static/wintun.dll`
2. å®‰è£… TUN é©±åŠ¨ï¼š

```bat
# æ‰“å¼€ç®¡ç†å‘˜ CMDï¼Œæ‰§è¡Œ
wintun-install.bat
```

æˆ–è€…ï¼š

- æ‰‹åŠ¨ä¸‹è½½å®‰è£… [Wintun é©±åŠ¨](https://www.wintun.net/)
- ä½¿ç”¨ Clash For Windows ç‰ˆæœ¬ >= 0.20.xï¼ˆå†…ç½®é©±åŠ¨ï¼‰

------

### ğŸš© åŸå›  2ï¼šDNS åŠ«æŒé…ç½®é”™è¯¯å¯¼è‡´ç½‘ç»œè§£æå¤±è´¥

å½“ TUN æ¨¡å¼å¼€å¯åï¼ŒClash ä¼šæ¥ç®¡ DNSï¼Œå¦‚æœ DNS æ²¡è®¾ç½®å¥½ï¼Œç³»ç»Ÿå°±â€œçœ‹ä¸åˆ°äº’è”ç½‘â€ã€‚

#### âœ… æ·»åŠ  DNS é…ç½®ï¼š

ç¼–è¾‘ä½ çš„ `config.yaml`ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼ˆå¦‚æœæ²¡æœ‰ `dns:` å­—æ®µï¼‰ï¼š

```yaml
dns:
  enable: true
  listen: 0.0.0.0:53
  enhanced-mode: fake-ip
  nameservers:
    - 8.8.8.8
    - 1.1.1.1
  fallback:
    - tls://dns.google
    - tls://1.1.1.1
```

å¦‚æœä½ å·²ç»æœ‰ `dns:` å­—æ®µï¼Œåªéœ€ç¡®ä¿é‡Œé¢çš„æœåŠ¡å™¨èƒ½æ­£å¸¸è®¿é—®ï¼ˆå»ºè®®ç”¨ 8.8.8.8ï¼‰ã€‚

------

### ğŸš© åŸå›  3ï¼šTUN è™šæ‹Ÿç½‘å¡æ²¡æœ‰è®¾ç½®æ­£ç¡®çš„è·¯ç”±

æœ‰æ—¶ç³»ç»Ÿæ— æ³•æ­£ç¡®è®¾ç½®é»˜è®¤è·¯ç”±åˆ°è™šæ‹Ÿç½‘å¡ï¼Œå¯¼è‡´æ‰€æœ‰ç½‘ç»œè¯·æ±‚â€œæ‰¾ä¸åˆ°å‡ºå£â€ã€‚

#### âœ… æ·»åŠ  `tun:` å­—æ®µï¼ˆæ‰‹åŠ¨ï¼‰

ç”±äº Clash GUI æ²¡è‡ªåŠ¨å†™å…¥ï¼Œä½ å¯ä»¥æ‰‹åŠ¨æ·»åŠ ä»¥ä¸‹å­—æ®µåˆ° `config.yaml`ï¼š

```yaml
tun:
  enable: true
  stack: system
  dns-hijack:
    - any:53
  auto-route: true
  auto-detect-interface: true
```

âš ï¸ æ³¨æ„ç¼©è¿›ï¼Œ`tun:` å­—æ®µå¿…é¡»åœ¨ `mixed-port:` ç­‰é¡¶å±‚å­—æ®µåŒä¸€ç¼©è¿›çº§åˆ«ä¸‹ã€‚

------

## âœ… æ¨èæ“ä½œæµç¨‹æ±‡æ€»

1. **ç¡®è®¤ Clash æ˜¯ç®¡ç†å‘˜å¯åŠ¨ & å¯ç”¨ Service Mode**
2. **ç¡®è®¤è®¾å¤‡ç®¡ç†å™¨ä¸­å­˜åœ¨ TUN è™šæ‹Ÿç½‘å¡**
3. **æ‰‹åŠ¨ç¼–è¾‘ `config.yaml` æ·»åŠ  `tun:` å­—æ®µ**
4. **æ·»åŠ æˆ–ä¿®æ”¹ `dns:` å­—æ®µï¼Œç¡®ä¿èƒ½è§£æå¤–ç½‘åŸŸå**
5. é‡å¯ Clashï¼Œå¹¶åœ¨ GUI ä¸­æ‰“å¼€ TUN æ¨¡å¼

------

## ğŸ å‚è€ƒå®Œæ•´é…ç½®ç‰‡æ®µï¼ˆåˆå¹¶ç‰ˆï¼‰

```yaml
mixed-port: 7890
allow-lan: false
external-controller: 127.0.0.1:51033
secret: 12899b79-1dcd-40e0-b33b-d64996c26862

tun:
  enable: true
  stack: system
  dns-hijack:
    - any:53
  auto-route: true
  auto-detect-interface: true

dns:
  enable: true
  listen: 0.0.0.0:53
  enhanced-mode: fake-ip
  nameservers:
    - 8.8.8.8
    - 1.1.1.1
  fallback:
    - tls://dns.google
    - tls://1.1.1.1
```

------

## å¦‚æœä»ç„¶æ–­ç½‘æ€ä¹ˆåŠï¼Ÿ

ğŸ›  è¯·æ£€æŸ¥è¿™äº›ç‚¹ï¼š

| æ£€æŸ¥é¡¹                  | è¯´æ˜                                        |
| ----------------------- | ------------------------------------------- |
| ç®¡ç†å‘˜å¯åŠ¨ Clash        | å¿…é¡» âœ…                                      |
| TUN ç½‘å¡æ˜¯å¦å­˜åœ¨        | è®¾å¤‡ç®¡ç†å™¨ä¸­çœ‹åˆ° clash-tun                  |
| æœ¬åœ° DNS æ˜¯å¦è¢«åŠ«æŒ     | å»ºè®® flush DNS åå†è¯•ï¼š`ipconfig /flushdns` |
| å®‰è£…äº†é˜²ç«å¢™ / æ€æ¯’è½¯ä»¶ | æœ‰äº›é˜²ç«å¢™ä¼šæ‹¦æˆª tun æ¥å£                   |

------

å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥å°†ä½ çš„å®Œæ•´ `config.yaml` å‘ç»™æˆ‘ï¼ˆå»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é—æ¼ã€‚

æ˜¯å¦è¦æˆ‘æä¾›ä¸€ä¸ªå¸¦è·¯å¾„æŒ‡å¼•çš„ä¿®æ”¹æ•™ç¨‹ï¼ˆå›¾æ–‡æˆ–æ­¥éª¤åˆ—è¡¨ï¼‰ï¼Ÿ

