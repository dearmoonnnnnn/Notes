# 一、简介：

融合标定完成后的毫米波雷达与激光雷达点云数据，使得时间戳相近的数据被存在同一个帧中。

- 以毫米波点云作为主力
  - 若不存在与当前毫米波点云帧时间同步的激光雷达点云，仍然保留当前帧。
  - 若激光雷达点云没有对应的时间同步的毫米波雷达

# 二、思路：

##### 总输入：

包含了两个话题的bag文件

##### 总输出：

只包含一个毫米波点云的bag文件，其中与激光雷达点云时间同步的帧进行了点云融合操作

##### step0: 将两个话题写入同一个bag包中

```bash
run rosbag_tools bag_merging
```

##### step1: 进行时间同步

- 使用approximate同步器保留两个话题中时间同步的消息

  - 输入：包含如下两个话题的bag文件
    - `/ars548_process/detection_point_cloud`话题的`sensor_msgs::PointCloud`消息
    - `/livox/lidar`话题的`CustomMsg`消息

  - 输出
    - 包含了时间同步的上述两种消息的bag文件

##### step2: 格式转换

- 将毫米波雷达的`sensor_msgs::PointCloud`格式转换为`sensor_msgs::PointCloud2`格式
  1. 创建`pcl::PointCloud<T>`点云，填充点后，使用`toROSMsg`转换为`sensor_msgs::PointCloud2`
  2. 由于pcl不存在一个点类型能包含位置、强度和多普勒速度信息，自定义一个点的类型

- 将激光雷达的`CustomMsg`格式转换为`sensor_msgs::PointCloud2`格式 

##### step3: 点云融合

将时间同步后的两种雷达直接拼接

- 使用`approximate`确保拼接的帧时间同步
- 只保留与毫米波点一定距离内的激光雷达点

##### step4: 将未融合的帧重新加入时间序列

1. 将时间同步后的毫米波点云序列与源点云序列进行比较，在不同帧之间将未插值过的点云帧重新加入。

# 三、其他

## 1、自定义pcl点的类型

##### 动机：

使用`pcl`库处理点云数据时，需要先将点云转换为`pcl::PointCloud<T>`类型，其中T为点的类型。

由于pcl没有一个标准的点类型能够同时包含**位置**、**强度**和**多普勒速度**信息，需要自定义点类型。

##### 代码实现：

```c++
#ifndef POINT_XYZIDV_H
#define POINT_XYZIDV_H

#include <pcl/point_types.h>
#include <pcl/point_cloud.h>

// 定义自定义点类型
namespace pcl
{
  struct PointXYZIDV
  {
    PCL_ADD_POINT4D;            // 这个宏定义将会添加成员 x, y, z 和 padding
    float intensity;            // 强度信息
    float doppler_velocity;     // 多普勒速度信息

    EIGEN_MAKE_ALIGNED_OPERATOR_NEW   // 确保内存对齐
  } EIGEN_ALIGN16;                    // 强制16字节对齐
}

// 注册自定义点类型
POINT_CLOUD_REGISTER_POINT_STRUCT(pcl::PointXYZIDV,
                                  (float, x, x)
                                  (float, y, y)
                                  (float, z, z)
                                  (float, intensity, intensity)
                                  (float, doppler_velocity, doppler_velocity))

#endif // CUSTOM_POINT_TYPES_H

```

##### 与ROS项目的兼容：

- 将上述代码写入`point_xyzidv.h`文件中，该文件放于`include`文件夹下。

- `cmakelist.txt`文件

  ```cmake
  # 项目包含头文件则需要在catkin_package中加上INCLUDES_DIRS
  catkin_package(
    INCLUDE_DIRS
    ......
  )
  
  include_directories(
    src
    # 
    include
    ${catkin_INCLUDE_DIRS}
    ${OpenCV_INCLUDE_DIRS}
  )
  ```


##### 测试：

经测试，`pcl::PointCloud<pcl::PointXYZIDV>`能够完美`pcl`库相关函数兼容

- `pcl::fromROSMsg()`
  - 调试输出正确的信号强度与多普勒速度
- `pcl::toROSMsg()`
  - 调试输出正确的信号强度与多普勒速度

# 四、TODO

- [ ] 在融合之前进行数据预处理，消除噪声

- [ ] 融合后，继续填充激光雷达点，与第一次融合后的点云在一定距离阈值内

