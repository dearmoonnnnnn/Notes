# 零、问题&概念

## 问题

##### 1、去畸变的原理是什么，为什么要使用 `IMU` 队列？

`IMU` 队列得到传感器运动轨迹，可以消除运动产生的畸变

## 概念

##### 1、扫描周期

传感器完成一次完整扫描所需的时间。

**如何使用扫描周期**

在代码中，扫描周期用于计算每个点在扫描过程中所对应的时间偏移，从而对其位置进行精确修正。以下是具体的实现步骤：

1. **计算时间偏移**：
    ```cpp
    double delta_t = scan_period * static_cast<double>(i) / cloud->size();
    ```
    这里 `scan_period` 表示完整扫描周期，`i` 是点的索引，`cloud->size()` 是点云中点的总数。`delta_t` 表示点 `i` 在扫描周期内的时间偏移。

2. **计算旋转变换**：
    ```cpp
    Eigen::Quaternionf delta_q(1, delta_t / 2.0 * ang_v[0], delta_t / 2.0 * ang_v[1], delta_t / 2.0 * ang_v[2]);
    ```
    根据时间偏移 `delta_t` 和角速度 `ang_v` 计算对应的旋转四元数 `delta_q`。

3. **应用逆旋转变换**：
    ```cpp
    Eigen::Vector3f pt_ = delta_q.inverse() * pt.getVector3fMap();
    ```
    将点 `pt` 的坐标乘以四元数的逆来应用去畸变变换。

**扫描周期在去畸变中的重要性**

激光雷达在运动中扫描时，每个点的采集时间不同，导致相同时间内采集的点的位置不一致。这种情况在高速运动或旋转中更加明显。去畸变的目的是利用IMU数据来补偿这些时间差异，以恢复点云数据在统一时间点的真实位置。

以下是一个简化的示例，说明扫描周期在去畸变中的应用：

1. **扫描开始**：
    - 时间戳：`t0`
    - 激光雷达开始扫描并采集第一个点

2. **扫描中间**：
    - 时间戳：`t0 + delta_t`
    - 激光雷达在扫描过程中继续采集点

3. **扫描结束**：
    - 时间戳：`t0 + scan_period`
    - 激光雷达完成一次完整扫描

在整个扫描周期内，不同时间点采集的数据点通过 `IMU` 数据进行修正，使得所有点的时间戳都相对于同一个参考时间点，从而消除因运动引起的畸变。

# 一、slam预处理节点中的操作

## 1、passthrough()

点云区域截取，截取z坐标在一定范围内的点云（-2 ~ 10）

## 2、downsample()

下采样

##### 动机：

- 减少点云中的点数，降低数据量和计算复杂度。
- 提高点云处理，同时保留尽可能多的关键信息

##### 方法1：VOXELGRID

基于体素的降采样技术，具体步骤：

1. **划分体素网格**
   - 将点云所在的空间分为一系列三维网格单元，称为体素（Voxel）
2. **统计体素内点**
   - 对于每个体素，统计落在其中的点
3. **体素中心计算**
   - 用每个体素的质心来代表该体素，从而减少数据量
     - 质心即这些点的平均值

##### 方法2：APPROX_VOXELGRID

也是基于体素的降采样技术，但它的计算更加高效，步骤如下：

1. **划分体素网格**
   - 将点云所在空间划分为体素网格
2. **统计体素内点**
3. **近似中心点**
   - 在计算体素内代表点时，不计算所有点的质心，而是选择一个代表点，减少了计算量。

##### 两种方法的关联和区别：

- 都是基于体素网格的降采样技术
- 都通过减少点云中的点数来提高处理效率
- VOXELGRID计算每个体素内点的质心
  - 保留更多细节信息，但计算量较大

- APPROX_VOXELGRID选择一个代表点
  - 计算量较小，但可能丢失一些细节信息


## 3、outlier_removal()

离群点去除

##### 动机：

移除噪声和异常的点

##### 方法1：STATISTICAL

1. **计算领域点**
   - 对于每个点，找到其在某个领域半径内的所有邻近点
2. **计算距离均值和标准差**
   - 计算该点到其领域内所有点的均值和标准差
3. **离群点判定**
   - 根据设定的阈值（通常为距离均值的某个倍数），判断点是否为离群点。超出阈值范围内的点被认为是离群点并移除。

##### 方法2：RADIUS

基于固定半径的领域搜索来检测和移除离群点，步骤如下：

1. **设置半径**
   - 固定一个搜索半径
2. **计算领域点数**
   - 对每个点，计算该固定半径内的领域点的数量
3. **离群点判定**
   - 根据设定的阈值（通常是领域点的最小数量），判断该点是否为离群点。若果一个点在其领域内的点数少于阈值，则认为该点是离群点并被移除

##### 两种方法的区别

- `STATISTICAL` 基于统计学原理，利用距离的均值和标准差来判断离群点。
  - 计算复杂度较高
  - 适用于点云分布较均匀的情况
- `RADIUS` 基于几何特性，通过领域点的数量来判断离群点。
  - 计算复杂度低
  - 适用于点云分布较稀疏的情况

## 4、distance_filter()

距离过滤

根据预先设定的距离阈值和z坐标范围过滤

## 5、deskewing()

去畸变

==使用imu队列去除畸变==

##### 畸变的来源：

传感器在采集数据时自身也在移动。传感器的运动（如旋转）会导致采集到的点相对于世界坐标系发生畸变。

##### 原理：

- 去除运动引起的畸变，需要考虑传感器的运动轨迹。

- 计算出每个点被测量时，传感器在一个扫描周期内的相对位姿变换。
  - 对点进行相对位姿的逆变换。

##### TODO:

消除平移带来的畸变。