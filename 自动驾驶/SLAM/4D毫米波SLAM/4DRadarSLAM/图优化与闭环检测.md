- [零、问题 \& 概念 \& 数据结构](#零问题--概念--数据结构)
  - [概念](#概念)
        - [1. 地面系数（floor\_coeffs）](#1-地面系数floor_coeffs)
        - [2. 信息矩阵](#2-信息矩阵)
        - [3. 状态估计](#3-状态估计)
        - [4. 环键 \& 扇形键](#4-环键--扇形键)
  - [问题](#问题)
        - [1. `new_keyframes` 和 `keyframes` 的区别](#1-new_keyframes-和-keyframes-的区别)
        - [2. 信息矩阵在回环检测中的作用](#2-信息矩阵在回环检测中的作用)
        - [3. 关键帧中的索引 index 和 id 的区别](#3-关键帧中的索引-index-和-id-的区别)
  - [数据结构](#数据结构)
        - [1. 上下文描述符](#1-上下文描述符)
        - [2. 环键 \& 扇形键](#2-环键--扇形键)
        - [3. 关键帧 KeyFrame](#3-关键帧-keyframe)
        - [4. 位姿图](#4-位姿图)
        - [5. node](#5-node)
- [一、闭环检测](#一闭环检测)
  - [1. flush\_keyframe\_queue()](#1-flush_keyframe_queue)
  - [2. optimization\_timer\_callback()](#2-optimization_timer_callback)
  - [3. addLoopFactor()](#3-addloopfactor)
- [二、radar\_graph\_slam](#二radar_graph_slam)
  - [1. loop\_detector](#1-loop_detector)
- [三、g2o](#三g2o)
- [四、scan\_context](#四scan_context)
  - [1. KDTreeVectorOfVectorsAdaptor.h](#1-kdtreevectorofvectorsadaptorh)
  - [2. nanflann.hpp](#2-nanflannhpp)
        - [相关连接：](#相关连接)
        - [作用：](#作用)
        - [如何使用：](#如何使用)
  - [3. Scancontext（定义类 `SCManager`）](#3-scancontext定义类-scmanager)
    - [3.1 SCManager](#31-scmanager)
    - [3.2 setScDistThresh](#32-setscdistthresh)
    - [3.3 setAzimuthRange](#33-setazimuthrange)
    - [3.4 makeScancontext](#34-makescancontext)
    - [3.5 makeRingkeyFromScancontext](#35-makeringkeyfromscancontext)
    - [3.6 makeSectorkeyFromScancontext](#36-makesectorkeyfromscancontext)
    - [3.7 fastAlignUsingVkey](#37-fastalignusingvkey)
    - [3.8 distDirectSC](#38-distdirectsc)
    - [3.9 distanceBtnScanContext](#39-distancebtnscancontext)
    - [3.10 makeAndSaveScancontextAndKeys（User-side API）](#310-makeandsavescancontextandkeysuser-side-api)
    - [3.11 detectLoopClosureID（User-side API）](#311-detectloopclosureiduser-side-api)
    - [3.12 getConstRefRecentSCD](#312-getconstrefrecentscd)
  - [4. tictor.h](#4-tictorh)


# 零、问题 & 概念 & 数据结构

## 概念

##### 1. 地面系数（floor_coeffs）

- 表示地面平面方程的系数。

- 用于描述地面的几何形状，可以在地面检测和约束中起重要作用。

地面平面方程：
$$
ax + by + cz + d = 0
$$

- 这里的 `a`、`b`、`c`、`d` 就是地面系数，通常存储在 `Eigen::Vector4d` 类型的变量中。

  ```cpp
  boost::optional<Eigen::Vector4d> floor_coeffs;
  ```

作用：

1. **地面检测**：通过检测地面平面，==滤掉非地面点==，提高 SLAM 系统的鲁棒性和效率。
2. **约束和校正**：可以用来构建约束条件，帮助在优化过程中保持机器人的姿态与地面平行。
3. **环境理解**：知道地面的位置信息，有助于理解和重建周围环境，例如在三维重建或导航规划中识别可通行区域和障碍物。

##### 2. 信息矩阵

Information Matrix

是协方差矩阵的逆矩阵。

- **协方差矩阵**描述了状态估计的不确定性
- **信息矩阵**描述了状态估计的确定性

##### 3. 状态估计

- 状态估计是指通过测量和算法来推断系统当前状态的过程。

- 在SLAM中，状态估计指的是机器人在环境中位姿的估计。

##### 4. 环键 & 扇形键

环键

- 点云数据在径向（距离）上的离散化。
- 雷达捕获到的点按照与中心点的距离被分到不同的环（rings）中。每个环代表了一定距离范围内的点云数据。

扇形键

- 点云数据在角向（方位角）上的离散化。
- 在极坐标系中，每个点的位置都可以用一个方位角和一个距离表示。扇形键将360度的视角分割成多个扇形区域。

结合使用

- 可以将激光雷达的点云数据组织成一个二维矩阵

- 行代表环，列代表扇形，每个单元格内的数值表示该环和扇形组合内点的数量。

- 这样，整个点云就被转换成了一个描述环境特征的直方图。

  

## 问题

##### 1. `new_keyframes` 和 `keyframes` 的区别

##### 2. 信息矩阵在回环检测中的作用

1. **表示约束的置信度**：

   信息矩阵表示一个节点到另一节点的位姿约束（位姿变换）的置信度。较大的信息矩阵表示较大的置信度。

2. **影响优化结果**：

   高置信度的约束对优化结果有更大的影响力。

3. **控制噪声的传播**：

   精确的位姿估计具有

##### 3. 关键帧中的索引 index 和 id 的区别

`index`

- **类型**：`size_t`
- 是关键帧在一个有序序列中的位置。
  - 例如，当处理一系列激光雷达帧时，每个帧都按顺序存储，`index` 表示这个帧在序列中的位置。

- **两种解释**：1. 当前关键帧在关键帧序列中的索引。2. 当前关键帧在原始数据序列中的索引。
  - 这里倾向于第二种。


`id()`

- 是从 `g2o` 库中图优化节点（`g2o::VertexSE3`）获取的标识符。`id` 是图优化节点的唯一标识符。

区别

1. **来源**
   - `index` 是由系统或程序在创建关键帧时按顺序分配的。
   - `id` 是由图优化库（如 `g2o`）在添加节点时分配的 

## 数据结构

##### 1. 上下文描述符

- `MatrixXd`

##### 2. 环键 & 扇形键

- `MatrixXd`

##### 3. 关键帧 KeyFrame

自定义结构体 `KeyFrame`

```cpp
/**
 * @brief KeyFrame (pose node)
 */
struct KeyFrame {
public:
  EIGEN_MAKE_ALIGNED_OPERATOR_NEW
  using PointT = pcl::PointXYZI;
  using Ptr = std::shared_ptr<KeyFrame>;

  KeyFrame(const size_t index, const ros::Time& stamp, const Eigen::Isometry3d& odom_scan2scan, double accum_distance, const pcl::PointCloud<PointT>::ConstPtr& cloud);
  KeyFrame(const std::string& directory, g2o::HyperGraph* graph);
  virtual ~KeyFrame();

  void save(const std::string& directory);
  bool load(const std::string& directory, g2o::HyperGraph* graph);

  long id() const;
  Eigen::Isometry3d estimate() const;

public:
  size_t index;
  ros::Time stamp;                                // timestamp
  Eigen::Isometry3d odom_scan2scan;               // odometry (estimated by scan_matching_odometry)
  Eigen::Isometry3d odom_scan2map;
  double accum_distance;                          // accumulated distance from the first node (by scan_matching_odometry)
  pcl::PointCloud<PointT>::ConstPtr cloud;        // point cloud
  boost::optional<Eigen::Vector4d> floor_coeffs;  // detected floor's coefficients
  boost::optional<Eigen::Vector3d> utm_coord;     // UTM coord obtained by GPS
  boost::optional<Eigen::Vector1d> altitude;      // Altitude (Filtered) obtained by Barometer

  boost::optional<Eigen::Vector3d> acceleration;    //
  boost::optional<Eigen::Quaterniond> orientation;  //

  geometry_msgs::Transform trans_integrated; // relative transform obtained by imu preintegration

  boost::optional<sensor_msgs::Imu> imu; // the IMU message close to keyframe_

  g2o::VertexSE3* node;  // node instance
};
```

**成员变量**

|      变量名称      |                  变量类型                   |                      描述                      |
| :----------------: | :-----------------------------------------: | :--------------------------------------------: |
|      `index`       |                  `size_t`                   |          关键帧在原始数据序列中的位置          |
|      `stamp`       |                 `ros::Time`                 |                     时间戳                     |
|  `odom_scan2scan`  |             `Eigen::Isometry3d`             |            由扫描匹配里程估计的位姿            |
|  `odom_scan2map`   |             `Eigen::Isometry3d`             | 相对于地图的位姿（可能需要在实际代码中初始化） |
|  `accum_distance`  |                  `double`                   |           从第一个节点开始的累计距离           |
|      `cloud`       |     `pcl::PointCloud<Point>::ConstPtr`      |                    点云数据                    |
| `trans_integrated` | `geometry_msgs::Transform trans_integrated` |          通过IMU预积分获得的相对变换           |
|       `node`       |              `g2o::VertexSE3*`              |                    节点实例                    |

**可选成员变量**

|    变量名称    |               变量类型                |            描述            |
| :------------: | :-----------------------------------: | :------------------------: |
| `floor_coeffs` |  `boost::optional<Eigen::Vector4d>`   |      检测到的地面系数      |
|  `utm_coord`   |   `boot::optional<Eigen::Vector3d>`   |  通过 GPS 获得的 UTM 坐标  |
|   `altitude`   |   `boot::optional<Eigen::Vector1d>`   | 通过气压计过滤后的海拔高度 |
| `acceleration` |  `boost::optional<Eigen::Vector3d>`   |           加速度           |
| `orientation`  | `boost::optional<Eigen::Quaterniond>` |        姿态（方向）        |



##### 4. 位姿图

`g2o` 中定义的类 `HyperGraph` 	



##### 5. node

`g2o::VertexSE3 *`

#  一、闭环检测

在 `radar_graph_slam_nodelet` 中

## 1. flush_keyframe_queue()

- 描述
  - 添加所有关键帧到位姿图中

## 2. optimization_timer_callback()

- 描述
  - 将队列中的所有数据添加到位姿图中，然后优化位姿图。
    - 包括关键帧、下限系数
- 参数
  - `event`
    - **参数类型**：`ros::WallTimerEvent&`
    - 定时器回调函数的参数
- 关键变量
  - 

## 3. addLoopFactor()

- 描述
  - 将检测到的回环添加到位姿图中
    - 使用 `graph_slam->add_se3_edge(s)` 函数
  - 为回环边添加==鲁棒核函数==
    - `graph->add_robust_kernel()`
- 关键变量
  - `loop_detector`
  - 


# 二、radar_graph_slam

## 1. loop_detector

1.1 LoopDetector

- 描述
  - 构造函数
- 关键参数
  - scManager
    - **参数类型**：`std::unique_ptr<SCManager>`
    - SCManager 类的实例化对象指针

# 三、g2o

# 四、scan_context

## 1. KDTreeVectorOfVectorsAdaptor.h





## 2. nanflann.hpp

只需要知道怎么使用，不用解读源码

##### 相关连接：

https://blog.csdn.net/u013019296/article/details/109377104

##### 作用：

用于构建具有**不同拓扑**的 KD 树

- R2
- R3：点云
- SO(2)：2D旋转组
- SO(3)：3D旋转组

##### 如何使用：



## 3. Scancontext（定义类 `SCManager`）

### 3.1 SCManager

- 描述
  - 构造函数，使用默认无参

### 3.2 setScDistThresh

- 描述
  - 设置距离阈值

### 3.3 setAzimuthRange

- 描述
  - 设置 Azimuth 角度

### 3.4 makeScancontext

- 描述

  - 从点云下采样生成扫描上下文描述符

- 返回值

  - **类型**：`Eigen::MatrixXd`

    

### 3.5 makeRingkeyFromScancontext

- 描述
  - 从扫描上下文描述符生成环键
- 返回值
  - **类型**：`Eigen::MatrixXd`

### 3.6 makeSectorkeyFromScancontext

- **描述**
  
  从扫描上下文生成扇形键
- **返回值**
  
  - **类型**：`Eigen::MatrixXd`

### 3.7 fastAlignUsingVkey

- 描述
  - 执行两个键之间的快速对齐
    - 这里只用于两个扇形键，排除方位角对于闭环检测的影响。
  - 索引从 0 遍历到 `_vkey1` 的行数，对于每一个索引，变换 `_vkey2`，得到使得 `_vkey1` 和 变换后的`_vkey2` 之间距离最近的索引。
- 关键变量
  - `argmin_vkey_shift`
    - 表示两个键之间的最佳变换的索引
    - 初始值为 0
  - `min_vkey_diff_norm`
    - 存储 `_veky1`  和 变换之后的 `_vkey2` 之间的**最小范式(距离)**
- 返回值
  - `argmin_vkey_shift`

### 3.8 distDirectSC

- **描述**：计算两个上下文描述符的直接距离

### 3.9 distanceBtnScanContext

- **描述**：计算两个上下文描述符之间的直接距离和角度差异

### 3.10 makeAndSaveScancontextAndKeys（User-side API）

- **描述**：生成扫描上下文和键
- **输入**：`_scan_down`
  - 下采样点云
  - 类型：`pcl::PointCloud<SCPointType> &`

### 3.11 detectLoopClosureID（User-side API）

- 描述
  - ==检测闭环ID==
- 输入参数
  - `cadidate_keyframes`
    - **参数类型**：`const std::vector<KeyFrame::Ptr>&`
    - 候选关键帧的指针向量

  - `new_keyframe`
    - **参数类型**：`const KeyFrame::Ptr&`
    - 新的关键帧指针

- 关键变量
  - `loop_id`
    - **类型**：int
    - 关键帧索引，初始化为-1，表示没有闭环

- **返回值**：一对
  - 包含闭环关键帧索引和偏航角差

### 3.12 getConstRefRecentSCD

- 描述
  - 返回一个 `Eigen::MatrixXd` 类型的引用常量，表示最近的扫描上下文描述符
- 关键变量
  - `polarcontexts_`：存储 `Eigen::MatrixXd` 类型对象的容器


## 4. tictor.h