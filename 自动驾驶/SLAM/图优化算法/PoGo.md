# 零、问题&相关概念

## Question

##### 1、带噪声的视角图，噪声指的是什么?

指异常或者冗余的边

##### 2、为什么要去除离群边，保留离群边带来的缺陷是什么？

##### 3、特征和消息的区别是什么？

- 特征：特征与边和节点有关，它们都代表着用于PoGO-Net中的GNN中的信息。特征的更新基于邻居节点和边的信息。
- 消息：消息是图中的节点用来传播信息的载体。消息是基于邻居节点和边进行计算的，并且被送到目标节点来更新其状态（state）。

总得来说，特征代表初始化的信息，与每一个点和边相关。消息是用来传播节点之间的信息的。

##### 4、节点(node)和节点的状态(state of the node)有什么区别

- 节点代表着相机位姿。
- 节点的状态不仅包括相机位姿，还包括了边和邻居节点的信息。
  - 使用节点的状态有助于对输入的视角图的几何约束和==局部一致性==进行编码，这对位姿图优化很重要。

## Concepts

##### 1、SFM

 Structure-from-Motion，一种计算机视觉技术，通过分析连续图像序列中的运动信息来重建三维结构。

##### 2、相机的绝对方向

##### 3、前馈

##### 4、embedding，嵌入

[【学习笔记】图神经网络 之 Embedding构造（上） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/445850704)

embedding指对图中每个节点用向量表示，并且能合理反映出它们之间的关联。

##### 5、$\mathbb{SO}(3)$

##### 6、PGO

pose graph optimization，位姿图优化

##### 7、全局一致性和局部一致性

- 全局一致性：估计的相机姿势相互一致，也与观测到的数据(如图像特征和相对旋转的测量值)一致。

##### 8、MRA

MRA 代表多旋转平均值，这是 SLAM 系统中姿势图优化 (PGO) 涉及的变换同步问题。给定成对的相对摄像机姿势，PGO 涉及求解一组经过优化的全球一致绝对摄像机姿势。MRA 用于通过寻找一组与相对测量值全局一致的摄像机方向来估计摄像机的绝对方向。它涉及最小化成本函数，该成本函数会惩罚相对旋转测量值之间的差异。论文中提出的Pogo-net方案在其关节损失函数中使用了MRA公式，以实现对大规模场景的可靠推断。

# 一、PoGO

## 1、总体架构

PoGO-net架构

![image-20230609214930281](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20230609214930281.png)

- 输入：噪声视图
- 输出：优化的位姿图
- 由于相机的绝对方向在输入中是未知的，我们通过在最高度的节点（即与大多数节点相连）上播种生成树来初始化节点特征。
- 在去噪层的帮助下，初始化在图上传播，==主动去除离群边==。
- 该网络有多层前馈结构，由去噪层和GNN层组成。每次迭代中，去噪层在通过GNN层更新聚合消息之前，对异常边缘进行”掉边“方案。
- PoGO-Net是完全可微的，端到端训练，共同优化去噪层和GNN层。

## 2、特征嵌入

输入的视角图定义为：$G=(\mathcal{V},\mathcal{E})$

- $\mathcal{V}$表示顶点集合。
- $\mathcal{E}$表示边的集合，表示相对方向集，包含了位姿估计所需的大部分基本信息。
- $\widetilde{r}_{ij} ∈ \mathbb{SO}(3), (i,j)∈\mathcal{E}$，代表连接$v_i$和$v_j$的边的特征向量。
- $q_i∈\mathbb{SO}(3)， v_i∈\mathcal{V}$，代表顶点的特征向量。

邻接矩阵A

- 常规的GNN邻接矩阵A是一个二进制矩阵，代表着节点的邻接情况。
- 该工作中的邻接矩阵由参数化变量组成。具体来说，由A中的元素的值说明了相应的边所代表的的测量值是否可靠,即，小的值意味着边缘容易出现噪声甚至异常值。

## 3、消息聚合

网络采用==多层前馈架构==，利用消息传递方案实现，即聚合信息在每个节点的邻域内传播。

==网络设计了一种新的**联合消息聚合方案**，有效地编码节点消息和边消息：==

- $m_{q_i}^l=\rho(\widetilde{r}_{ij}|(i,j)∈\mathcal{E}^l)╫q_i^l$
  - m表示消息，message
  - 表示节点的消息
- $m_{\widetilde{r}_{ij}}^l = q_i^l ╫ q_j^l ╫ \widetilde{r}_{ij}^l$
  - 边的消息

- $m_{\pi_{ij}}^l = mean(\widetilde{r}_{ij}^l|(i,j)∈\mathcal{E}^l) ╫ \{q_j^l|v_j∈\mathcal{N}_i^l\}$
  - 节点状态的消息


## 4、图去噪

##### 动机：

由于输入经常存在异常值/冗余**边**，因此直接将GNN应用于PGO任务是不切实际的，因为沿着边的消息聚合机制可能会传播和放大整个图上的噪声。

##### 去噪方法：

在GNN层之间加入”边缘丢弃“去噪层。

邻接矩阵A的元素表示==回归==时边特征$\widetilde{r}_{ij}^l$的权重，$A^l$表示第$l$层的邻接矩阵，$A^l=A \odot \mathcal{Z}^l$，其中

- $\mathcal{Z}$表示二进制系数矩阵$\{z_{ij}^l\}$
- $\odot$表示逐元素相乘

根据先前的工作，不再使用二进制来表示$z_{ij}$，而是用边消息$m_{\widetilde{r}_{ij}}^l$的确定性函数$g$来表示

- $ z_{ij}^l = g(\omega_{\gamma^l} (m_ {\widetilde{r}_{ij} } ^l) ,\epsilon^l) $

......

## 5、图的初始化和更新

##### 初始化：

==通过在输入视角图中播种生成树来初始化节点。==

##### 图更新：

- 节点特征：通过消息聚合进行更新。
- 边特征：通过新的邻接矩阵隐式更新，具体来说，边特征和图连通性特征一起聚合在边消息中。每次进行边的消息传递之前，会删除离群边。

## 6、损失函数

两个部分：

- 边损失函数$\mathcal{L}_e$：衡量了输出位姿图的==全局一致性==。
- 节点损失函数$\mathcal{L}_v$：评估**绝对相机方向**的预测。

添加的损失：$l1$正则化损失$\mathcal{L}_r$

- 通过计算节点权重和边权重的加权总和得到。
  - 节点权重基于顶点度，顶点度指连接到特定节点的边的数量。
  - 边权重基于邻接系数$z_{ij}$，邻接系数表示图中两个节点之间的连接强度。
- $\mathcal{L}_r$计算了图结构复杂性的损失。这种惩罚有助于防止过度拟合，并确保优化后的相机位姿集具有全局一致性。

最终的损失$\mathcal{L}$
$$
\mathcal{L}=\alpha_e \mathcal{L}_e + \alpha_v\mathcal{L}_v + \alpha_r \mathcal{L}_r
$$

-  $\alpha_e, \alpha_v, \alpha_r ∈(0,1)$是权重参数。
